#!/bin/bash
# Pre-push hook: full typecheck + build + test verification

set -e

echo "üöÄ Running pre-push verification..."

# Set dummy environment variables for build (validation skipped via @t3-oss/env-nextjs)
export DATABASE_URL="postgresql://dummy:dummy@localhost:5432/dummy"
export NEXTAUTH_SECRET="dummy-secret-for-build"
export NEXTAUTH_URL="http://localhost:3000"
export SKIP_ENV_VALIDATION=1

# 1. Type check (fast, clear errors)
echo "üîé Running type check..."
if ! npm run typecheck; then
  echo "‚ùå Type check failed. Please fix type errors before pushing."
  exit 1
fi

# 2. Build verification
echo "üì¶ Building application..."
if ! npm run build; then
  echo "‚ùå Build failed. Please fix build errors before pushing."
  exit 1
fi

# 3. Test execution
echo "üß™ Running tests..."
if ! npm test; then
  echo "‚ùå Tests failed. Please fix failing tests before pushing."
  exit 1
fi

# Check if auth-related files changed (informational warning, non-blocking)
AUTH_FILES_CHANGED=$(git diff --name-only origin/main...HEAD 2>/dev/null | grep -E "(auth|session|login)" || true)

if [ -n "$AUTH_FILES_CHANGED" ]; then
  echo ""
  echo "‚ö†Ô∏è  Authentication-related files changed:"
  echo "$AUTH_FILES_CHANGED"
  echo "  Please verify login flow locally before merging."
  echo ""
fi

echo "‚úÖ Pre-push verification passed!"
